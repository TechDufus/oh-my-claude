name: Validate Plugin

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "Validating marketplace.json..."
          jq empty .claude-plugin/marketplace.json

          echo "Validating plugin.json..."
          jq empty plugins/oh-my-claude/.claude-plugin/plugin.json

          echo "Validating hooks.json..."
          jq empty plugins/oh-my-claude/hooks/hooks.json

      - name: Check version sync
        run: |
          MARKETPLACE_VERSION=$(jq -r '.plugins[0].version' .claude-plugin/marketplace.json)
          PLUGIN_VERSION=$(jq -r '.version' plugins/oh-my-claude/.claude-plugin/plugin.json)
          METADATA_VERSION=$(jq -r '.metadata.version' .claude-plugin/marketplace.json)

          echo "Marketplace plugin version: $MARKETPLACE_VERSION"
          echo "Plugin.json version: $PLUGIN_VERSION"
          echo "Marketplace metadata version: $METADATA_VERSION"

          if [ "$MARKETPLACE_VERSION" != "$PLUGIN_VERSION" ]; then
            echo "ERROR: Version mismatch between marketplace.json and plugin.json"
            exit 1
          fi

          if [ "$METADATA_VERSION" != "$PLUGIN_VERSION" ]; then
            echo "ERROR: Version mismatch between metadata.version and plugin.json"
            exit 1
          fi

          echo "Versions are in sync!"

      - name: Check for forbidden paths
        run: |
          echo "Checking for ../ paths in plugin.json..."
          if grep -r '\.\.\/' plugins/oh-my-claude/.claude-plugin/plugin.json; then
            echo "ERROR: Found forbidden ../ paths in plugin.json"
            exit 1
          fi
          echo "No forbidden paths found!"

      - name: Validate hook scripts exist
        run: |
          echo "Checking hook scripts..."
          HOOKS_DIR="plugins/oh-my-claude/hooks"

          # Extract Python script paths from uv commands (format: uv run --script /path/to/script.py)
          jq -r '.. | .command? // empty' "$HOOKS_DIR/hooks.json" | while read -r cmd; do
            # Extract the script path (last argument after --script)
            script=$(echo "$cmd" | grep -oE '\$\{CLAUDE_PLUGIN_ROOT\}/[^ ]+\.py' | sed 's|${CLAUDE_PLUGIN_ROOT}|plugins/oh-my-claude|g')
            if [ -z "$script" ]; then
              echo "SKIP: No Python script found in: $cmd"
              continue
            fi
            if [ ! -f "$script" ]; then
              echo "ERROR: Hook script not found: $script"
              exit 1
            fi
            if [ ! -x "$script" ]; then
              echo "ERROR: Hook script not executable: $script"
              exit 1
            fi
            echo "OK: $script"
          done
          echo "All hook scripts exist and are executable!"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Lint Python hooks
        run: |
          echo "Checking Python hook scripts..."
          uv tool install ruff
          find plugins/oh-my-claude/hooks -name "*.py" -type f | while read -r script; do
            echo "Checking $script..."
            ruff check "$script" || exit 1
          done
          echo "All Python scripts passed ruff!"

      - name: Run hook unit tests
        run: |
          echo "Running pytest on hook tests..."
          cd tests/oh-my-claude/hooks
          uv run --with pytest pytest . -v --tb=short
          echo "All tests passed!"

      - name: Shellcheck shell scripts
        run: |
          echo "Running shellcheck on shell scripts..."
          find plugins/oh-my-claude -name "*.sh" -type f | while read -r script; do
            echo "Checking $script..."
            shellcheck "$script" || exit 1
          done
          echo "All shell scripts passed shellcheck!"

      - name: Validate skill files exist
        run: |
          echo "Checking skill files..."
          PLUGIN_DIR="plugins/oh-my-claude"

          for skill in $(jq -r '.skills[]' "$PLUGIN_DIR/.claude-plugin/plugin.json"); do
            SKILL_PATH="$PLUGIN_DIR/$skill"
            if [ ! -f "$SKILL_PATH" ]; then
              echo "ERROR: Skill file not found: $SKILL_PATH"
              exit 1
            fi
            echo "OK: $SKILL_PATH"
          done
          echo "All skill files exist!"
